{% extends "base.html" %}
{% load static %}

{% block title %} Messenger {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/messenger/styles.css' %}">
{% endblock %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-center mb-3">
    <button id="btn-chats" class="btn btn-outline-secondary">Chats</button>
    <button id="btn-users" class="btn btn-outline-primary ms-2">Users</button>
  </div>

  <div class="row">
    <div class="col-md-3">
      <a href="{% url 'create_group' %}" class="mb-2 btn btn-outline-primary text-light w-100">➕ Create chat</a>
      <div id="user-list" class="list-group d-none mb-4">
        <div class="sticky-top" style="background-color: #1f1f2e; border: 1px solid #333;">
          <h4 class="text-center m-2 card-title">
            USERS
          </h4>
        </div>
        {% for user in user_friends %}
          <form method="post" action="{% url 'create_chat' %}">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">

            <button type="submit"
                    class="list-group-item list-group-item-action d-flex align-items-center gap-2">
              <img src="{{ user.avatar.url }}"
                  class="avatar-tiny rounded-circle"
                  alt="{{ user.username }}">
              <strong>{{ user.username }}</strong>
            </button>
          </form>
        {% empty %}
          <p class="text-light px-3 m-2">No one is following you.</p>
        {% endfor %}
      </div>
      
      <div id="chat-list" class="list-group mb-4">
        <div class="sticky-top" style="background-color: #1f1f2e; border: 1px solid #333;">
          <h4 class="text-center m-2 card-title" >
            CHATS
          </h4>
        </div>
        {% for c in chats %}
          <a href="{% url 'chat' c.id %}"
            class="list-group-item list-group-item-action {% if c.pk == chat.pk %}active-chat{% endif %}">
            {% if c.is_group %}
              {% with first_user=c.users.first %}
                <div class="d-flex gap-2">
                  <img src="{{ first_user.avatar.url }}" class="avatar-tiny rounded-circle">

                  <div class="d-flex flex-column">
                    <strong>{{ c.title }}</strong>
                    <small class="text-light opacity-75" style="font-size: 0.75rem;">
                      {{ c.users.count }} members
                    </small>
                  </div>
                </div>
              {% endwith %}
            {% else %}
              {% for u in c.users.all %}
                {% if u != request.user %}
                  <div class="gap-2 d-flex align-items-left">
                    <img src="{{ u.avatar.url }}" class="avatar-tiny rounded-circle">
                    <strong>{{ u.username }}</strong>
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </a>
        {% empty %}
          <div class="text-light text-center mt-2">No chats.</div>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-9">
      {% if chat.id %}
        <div class="d-flex align-items-center justify-content-between p-2 rounded bg-dark shadow-sm">

          <div class="d-flex align-items-center gap-2">

            {% if chat.is_group %}
              {% with first_user=chat.users.first %}
              <a href="{% url 'user_detail' first_user.slug %}" class="text-decoration-none">
                <img src="{{ first_user.avatar.url }}"
                    class="avatar-small rounded-circle">
              </a>
              {% endwith %}
            {% else %}
              {% for u in chat.users.all %}
                {% if u != request.user %}
                  <a href="{% url 'user_detail' u.slug %}">
                    <img src="{{ u.avatar.url }}"
                        class="avatar-small rounded-circle">
                  </a>
                {% endif %}
              {% endfor %}
            {% endif %}

            <div class="d-flex flex-column">
              <strong class="text-light">{{ chat.title }}</strong>
              {% if chat.is_group %}
                <small class="text-light">
                  {{ chat.users.count }} members
                </small>
              {% endif %}
            </div>
          </div>

          <div class="d-flex gap-2">
            {% if chat.is_group %}
              <button class="btn btn-sm btn-outline-info"
                      data-bs-toggle="modal"
                      data-bs-target="#groupInfoModal">
                ℹ️
              </button>
            {% endif %}

            <a href="{% url 'chat_edit' chat.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
            <a href="#" class="btn btn-sm btn-outline-danger" id="chat-delete-btn" 
                        data-delete-url="{% url 'chat_delete' chat.id %}" 
                        >Delete</a>
          </div>
        </div>
        {% endif %}

      {% if chat.id %}
        <div id="chat-box"
              class="chat-box p-4 mb-3 rounded shadow-sm
                      {% if chat.background %}chat-box--bg{% else %}chat-box--default{% endif %}"
              {% if chat.background %}
                data-bg-url="{{ chat.background.url }}"
              {% endif %}
              data-chat-id="{{ chat.id }}"
              data-current-user="{{ request.user }}"
          >
          {% for message in messages %}
            {% ifchanged message.created_at.date %}
              <div class="chat-date-divider my-3 text-center"
              data-date="{{ message.created_at|date:'Y-m-d' }}">
                <span class="px-3 py-1 rounded bg-dark text-light small">
                  <span class="date-label"
                        data-iso="{{ message.created_at|date:'Y-m-d' }}">
                    {{ message.created_at|date:"j E Y" }}
                  </span>
                </span>
              </div>
            {% endifchanged %}
            <div class="d-flex message-row
              {% if message.user == request.user %}
                justify-content-end
              {% else %}
                justify-content-start
              {% endif %}
              mb-3">

            {% if message.user != request.user %}
            <a href="{% url 'user_detail' message.user.slug %}" class="text-decoration-none">
              <img src="{{ message.user.avatar.url }}"
                  class="message-avatar">
            </a>
            {% endif %}

            <div class="message-content
                {% if message.user == request.user %}
                  message-own
                {% else %}
                  message-other
                {% endif %}"
                data-message-id="{{ message.id }}">

              <div>
                <a href="{% url 'user_detail' message.user.slug %}" class="text-decoration-none message-username">
                {{ message.user.username }}
                </a>
              </div>

              <div class="message-text">
                {{ message.text|linebreaksbr }}
              </div>

              <div class="message-time text-muted small text-end">
                {% if message.was_edited %}edited {% endif %}{{ message.created_at|date:"H:i" }}
              </div>

                <div class="message-reactions mt-1">
                  <div class="reactions-list d-inline-block">
                    {% for emoji, data in message.reactions_by_emoji.items %}
                      <button class="reaction-btn
                          {% if message.user_reacted_emoji == emoji %}
                            active-reaction-btn
                          {% else %}
                            reaction-inactive-btn
                          {% endif %}"
                          data-emoji="{{ emoji }}">
                        {{ emoji }}
                        
                        {% if data.count <= 3 %}
                          {% for user in data.users %}
                            <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="reaction-avatar" />
                          {% endfor %}
                        {% else %}
                          <span class="reaction-count">{{ data.count }}</span>
                        {% endif %}
                        
                      </button>
                    {% endfor %}
                  </div>
                  
                  <div class="emoji-picker d-none">
                    {% if message.was_edited %}
                      <div class="emoji-picker-header">
                        <span class="edited-time">
                          edited at {{ message.updated_at|date:"H:i d/m/Y" }}
                        </span>
                      </div>
                    {% endif %}

                    <div class="emoji-picker-body">
                      {% for emoji, label in emoji_choices %}
                        <span class="emoji-choice" data-emoji="{{ emoji }}">{{ emoji }}</span>
                      {% endfor %}
                    </div>

                    <hr>

                    {% if message.user == request.user %}
                      <div class="message-actions mt-2">
                        <a href="#" class="btn btn-sm btn-outline-danger message-delete-btn"
                          data-message-id="{{ message.id }}">Delete</a>
                        <a href="{% url 'message_edit' message.pk %}"
                          class="btn btn-sm btn-outline-warning message-update-btn"
                          data-message-id="{{ message.id }}">Edit</a>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <form id="message-form" class="d-flex" method="post" action="javascript:void(0)">
          {% csrf_token %}
          {{ form.text }}
          <button type="submit" class="btn btn-primary ms-2">Sent</button>
        </form>

      {% else %}
        <div id="chat-box"
            class="chat-box chat-box--empty d-flex justify-content-center align-items-center">
          <p class="card text-center p-2 fs-4 bg-dark text-light">
            Choose chat or user to start messaging.
          </p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<template id="message-template">
  <div class="d-flex message-row mb-3">
    <a class="message-avatar-link d-none">
      <img class="message-avatar avatar-small">
    </a>

    <div class="message-content" data-message-id="">
      <div>
        <a class="message-username text-decoration-none"></a>
      </div>

      <div class="message-text"></div>

      <div class="message-time"></div>

      <div class="message-reactions mt-1">
        <div class="reactions-list d-inline-block"></div>

        <div class="emoji-picker d-none">
          <div class="emoji-picker-body">
            {% for emoji, label in emoji_choices %}
              <span class="emoji-choice" data-emoji="{{ emoji }}">{{ emoji }}</span>
            {% endfor %}
          </div>

          <hr>

          <div class="message-actions mt-2 d-none">
            <a href="#" class="btn btn-sm btn-outline-danger message-delete-btn">Delete</a>
            <a href="#" class="btn btn-sm btn-outline-warning message-update-btn">Edit</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="date-divider-template">
  <div class="chat-date-divider my-3 text-center" data-date="">
    <span class="px-3 py-1 rounded bg-dark text-light small"></span>
  </div>
</template>



{% include "helpers/messenger/modal_info.html" %}
<script src="{% static 'js/messenger/script.js' %}"></script>
{% endblock %}
