{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow-sm border-0 mb-3" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header bg-white d-flex align-items-center justify-content-between" style="border-radius: 16px 16px 0 0;">
                    <div class="d-flex align-items-center">
                        <img src="{{ post.author.avatar.url }}"
                            alt="avatar"
                            class="rounded-circle me-3"
                            width="48" height="48">
                        <div>
                            <h6 class="fw-bold mb-0">
                                <a href="{% url 'user_detail' post.author.slug %}" class="text-decoration-none text-dark">
                                    {{ post.author.username }}
                                </a>
                            </h6>
                            <small class="text-muted">{{ post.created_at|date:"d M Y, H:i" }}</small>
                        </div>
                    </div>
                    {% if post.author == request.user %}
                    <div class="gap-2 d-flex">
                        <a href="{% url 'post_edit' post.pk %}" class="btn btn-sm btn-warning">
                            ‚úèÔ∏è Edit
                        </a>
                        <form method="POST" action="{% url 'post_delete' post.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this post?')">
                                üóëÔ∏è Delete
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h2 class="fw-bold mb-3">{{ post.title }}</h2>
                    <p class="text-dark" style="font-size: 1.1rem; line-height: 1.6;">
                        {{ post.content }}
                    </p>
                    {% if post.files.all %}
                    <div class="mt-3">
                        {% for file in post.files.all %}
                            <div class="mb-3">
                                {% if file.file_type  == "image" %}
                                    <img src="{{ file.file.url }}"
                                         class="img-fluid rounded"
                                         style="max-height: 400px; object-fit: cover;">
                                {% elif file.file_type == "video" %}
                                    <video class="w-100 rounded" controls>
                                        <source src="{{ file.file.url }}">
                                    </video>
                                {% else %}
                                    <a href="{{ file.file.url }}" download class="btn btn-outline-secondary">
                                        üìÑ {{ file.file.name }}
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <hr>
                    <div class="d-flex align-items-center justify-content-between mt-3 mb-2">
                        <button class="like-btn btn btn-light border px-3"
                                data-post-id="{{ post.id }}"
                                style="border-radius: 12px;">
                            ‚ù§Ô∏è <span class="likes-count">{{ likes_count }}</span>
                        </button>
                        <div class="text-muted">
                            üëÅÔ∏è {{ viewers_count }} views
                        </div>
                    </div>
                {% if post.people_tags.exists %}
                    <div class="mt-2">
                        üë• Tagged:
                        {% for user in post.people_tags.all %}
                            <a href="{% url 'user_detail' user.slug %}" 
                            class="badge bg-secondary text-decoration-none me-1">
                                {{ user.username }}
                            </a>
                        {% endfor %}
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow-sm border-0 d-flex flex-column"
             style="height: 75vh; border-radius: 16px; overflow: hidden;">
            <div id="comments-box"
                 class="flex-grow-1 overflow-auto p-3"
                 style="background: #fafafa;">
                <h5 class="mb-3">Comments</h5>
                <div id="comments">
                {% for comment in comments %}
                <div class="comment mb-2 p-2 border rounded bg-white"
                     data-comment-id="{{ comment.id }}">
                    <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>{{ comment.user.username }}</strong>:
                        <span class="comment-text">{{ comment.content }}</span>
                    </div>
                    {% if comment.user == request.user %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="dropdown">
                        ‚ãÆ
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <form method="POST" action="{% url 'comment_delete' post.pk comment.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Delete this comment?')">
                                Delete
                            </button>
                            </form>
                        </li>
                        <li>
                            <a href='{% url "comment_edit" comment.pk %}' class="dropdown-item text-warning ms-2 comment-update-btn" data-message-id="{{ comment.id }}">Edit</a>
                        </li>
                        </ul>
                    </div>
                    {% endif %}
                    </div>
                    <br>
                    <button class="like-comment-btn btn btn-sm btn-light px-2 mt-1"
                        data-comment-id="{{ comment.id }}">
                    üëç <span class="comment-likes-count">{{ comment.likes.count }}</span>
                    </button>
                </div>
                {% empty %}
                <p class="text-muted">No comments yet.</p>
                {% endfor %}
                </div>
            </div>
            <div class="p-3 border-top bg-white">
                <form method="POST" id="comment-form">
                {% csrf_token %}
                <div class="mb-2">
                    {{ comment_form.content }}
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit</button>
                </form>
            </div>
        </div>
    </div>

<script>

document.addEventListener("DOMContentLoaded", () => {

    const commentForm = document.getElementById("comment-form");
    const textarea = commentForm.querySelector("textarea");
    const submitBtn = commentForm.querySelector("button[type='submit']");

    let editingCommentId = null;
    let originalText = "";

    // ==== 1. –ù–ê–¢–ò–°–ö –ù–ê EDIT ====
    document.querySelectorAll(".comment-update-btn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault(); // –ó—É–ø–∏–Ω—è—î–º–æ –ø–µ—Ä–µ—Ö—ñ–¥ –ø–æ –ª—ñ–Ω—Ü—ñ

            editingCommentId = this.dataset.messageId;  // id –∫–æ–º–µ–Ω—Ç–∞
            const commentDiv = document.querySelector(`[data-comment-id="${editingCommentId}"]`);
            const textElement = commentDiv.querySelector(".comment-text");
            originalText = textElement.textContent.trim();

            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ —Ç–µ–∫—Å—Ç –≤ textarea
            textarea.value = originalText;
            textarea.focus();

            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–≤–∏—á–∞–π–Ω—É –∫–Ω–æ–ø–∫—É Submit
            submitBtn.style.display = "none";

            // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ Save + Cancel
            addEditButtons();
        });
    });

    // ==== 2. –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ Save / Cancel ====
    function addEditButtons() {
        if (document.getElementById("save-edit-btn")) return;

        const saveBtn = document.createElement("button");
        saveBtn.id = "save-edit-btn";
        saveBtn.className = "btn btn-success w-100 mb-2";
        saveBtn.textContent = "üíæ Save";

        const cancelBtn = document.createElement("button");
        cancelBtn.id = "cancel-edit-btn";
        cancelBtn.className = "btn btn-secondary w-100";
        cancelBtn.textContent = "‚úñ Cancel";

        commentForm.appendChild(saveBtn);
        commentForm.appendChild(cancelBtn);

        saveBtn.addEventListener("click", saveEdit);
        cancelBtn.addEventListener("click", cancelEdit);
    }

    // ==== 3. SAVE ====
    async function saveEdit(e) {
        e.preventDefault();

        const newContent = textarea.value.trim();

        if (!newContent) {
            alert("–ü–æ—Ä–æ–∂–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!");
            return;
        }

        const response = await fetch(`/posts/comment/${editingCommentId}/edit/`, {
            method: "POST",
            headers: {"X-CSRFToken": getCSRF()},
            body: JSON.stringify({content: newContent})
        });

        const data = await response.json();

        if (!data.success) {
            alert(data.error || "Error");
            return;
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
        const commentDiv = document.querySelector(`[data-comment-id="${editingCommentId}"]`);
        const textElement = commentDiv.querySelector(".comment-text");
        textElement.textContent = data.comment.content;

        finishEditing();
    }

    // ==== 4. CANCEL ====
    function cancelEdit(e) {
        e.preventDefault();

        textarea.value = "";
        finishEditing();
    }

    // ==== 5. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ñ–æ—Ä–º—É –≤ —Ä–µ–∂–∏–º "–∑–≤–∏—á–∞–π–Ω–∏–π"
    function finishEditing() {
        editingCommentId = null;

        // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É Submit
        submitBtn.style.display = "block";

        textarea.value = "";

        // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–Ω–æ–ø–∫–∏ Save / Cancel
        document.getElementById("save-edit-btn")?.remove();
        document.getElementById("cancel-edit-btn")?.remove();
    }

    // ==== CSRF ====
    function getCSRF() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
    }

});

</script>


{% endblock %}
